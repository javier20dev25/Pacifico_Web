<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root { --bg: #e9eef6; --card: #f6f8fb; --muted: #6b7280; --accent: #7ea1ff; }
    html, body { scroll-behavior: smooth; }
    body { background: linear-gradient(180deg, #e9eef6, #dfe8f8); font-family: 'Inter', sans-serif; color: #1a202c; }
    .neumorphic-card { background: var(--card); border-radius: 14px; box-shadow: 8px 8px 20px rgba(170, 187, 204, 0.18), -8px -8px 20px rgba(255, 255, 255, 0.9); }
    .btn { transition: transform 0.12s ease-in-out, box-shadow 0.12s ease-in-out; }
    .btn:active { transform: translateY(1px); box-shadow: none; }
    .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
    .tag-item { background-color: var(--accent); color: white; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem; }
    #cart-button-container { position: fixed; bottom: 20px; right: 20px; z-index: 40; }
    #cart-count { position: absolute; top: -5px; right: -5px; background-color: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Inyección de datos del servidor -->
  __DATA_INJECTION_POINT__

  <!-- Contenedor principal de la tienda -->
  <div id="store-container" class="container mx-auto p-4 md:p-6 lg:p-8"></div>

  <!-- Botón del carrito flotante -->
  <div id="cart-button-container"></div>

  <!-- Modales -->
  <div id="modals-container"></div>

  <script type="module">
    // Envolver todo en un try...catch para mostrar errores fatales
    try {
        // ========================================================== 
        // ESTADO Y CONFIGURACIÓN GLOBAL
        // ========================================================== 
        let store = {};
        let products = [];
        let shoppingCart = {}; // Formato: { productId: quantity } 
        let selectedShippingMethod = 'air'; // 'air' o 'sea'

        const $ = id => document.getElementById(id);
        const escapeHTML = (s) => (s || '').replace(/[&<>()"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '(': '&#40;', ')': '&#41;', '"': '&quot;', "'": '&#39;' })[c]);

        // ========================================================== 
        // INICIALIZACIÓN
        // ========================================================== 
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.STORE_DATA === 'undefined' || !window.STORE_DATA.store || !window.STORE_DATA.products) {
                const errorMsg = 'Error: STORE_DATA is missing or malformed.';
                console.error(errorMsg, window.STORE_DATA);
                $('store-container').innerHTML = `<h1 class="text-center text-2xl font-bold text-red-500">${errorMsg}</h1>`;
                return;
            }
            store = window.STORE_DATA.store;
            products = window.STORE_DATA.products;

            renderStoreView();
            renderModals();
            renderCartButton();
            attachGlobalListeners();
        });

        // ========================================================== 
        // FUNCIONES DE RENDERIZADO
        // ========================================================== 
        function renderStoreView() {
            document.title = store.nombre || 'Tienda';
            const storeContainer = $('store-container');
            const storeNameVal = store.nombre || 'Tienda Sin Nombre';
            const storeLogoUrl = store.logoUrl || 'https://placehold.co/80x80/e9eef6/6b7280?text=LOGO';
            
            let headerHtml = `
                <div class="text-center mb-6">
                    <img src="${storeLogoUrl}" class="w-20 h-20 rounded-full object-cover mx-auto mb-2 neumorphic-card" alt="Logo de la tienda">
                    <h3 class="text-2xl font-bold text-gray-800">${escapeHTML(storeNameVal)}</h3>
                    <p class="text-sm text-gray-600 mt-1">${escapeHTML(store.descripcion)}</p>
                    ${store.whatsapp ? `<a href="https://wa.me/${store.whatsapp.replace(/\s+|-/g, '')}" target="_blank" class="text-teal-600 text-xs font-semibold inline-flex items-center mt-2"><i class="fab fa-whatsapp mr-1"></i> Contactar por WhatsApp</a>` : ''}
                </div>
            `;

            const productsHtml = products.map((p, index) => {
                const id = p.idLocal;
                const tagsHtml = (p.tags || []).map(tag => `<span class="tag-item">#${escapeHTML(tag)}</span>`).join('');
                const { price: priceDisplay, time: timeDisplay } = getCustomerPriceAndDelivery(p);
                const deliveryNote = getCustomerDeliveryText();

                return `
                    <div class="neumorphic-card p-4 flex flex-col gap-3" data-id="${id}">
                        <img src="${p.imageUrl || 'https://placehold.co/400x300/f6f8fb/6b7280?text=IMG'}" class="w-full h-48 rounded-lg object-cover" alt="${escapeHTML(p.nombre)}">
                        <div class="flex-1">
                            <h5 class="text-lg font-bold text-gray-800">${escapeHTML(p.nombre || 'Producto sin nombre')}</h5>
                            <p class="text-xs text-gray-500 line-clamp-2 mt-1">${escapeHTML(p.descripcion || 'Sin descripción.')}</p>
                        </div>
                        <div class="border-t border-gray-100 pt-3 space-y-2">
                            ${priceDisplay}
                            <div class="text-xs text-gray-600 font-semibold pt-1">Tiempos de Entrega Estimados:</div>
                            ${timeDisplay}
                            <div class="text-sm border-t pt-2">${deliveryNote}</div>
                        </div>
                        <div class="flex flex-wrap gap-2 pt-1 border-t border-gray-100 mb-3">${tagsHtml}</div>
                        <button class="btn bg-teal-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-teal-600 text-sm flex items-center justify-center" onclick="handleCartAction('${id}', 'add')"><i class="fas fa-cart-plus mr-2"></i> Añadir al Carrito</button>
                    </div>
                `;
            }).join('');

            storeContainer.innerHTML = `
              <div class="text-left">
                ${headerHtml}
                <h4 class="text-xl font-bold mt-8 mb-4 border-t pt-4">Catálogo de Productos</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  ${productsHtml || `<div class="text-center text-gray-400 py-8">No hay productos añadidos.</div>`}
                </div>
              </div>
            `;
        }

        function renderModals() {
            const modalsContainer = $('modals-container');
            modalsContainer.innerHTML = `
                <div id="order-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay hidden">
                    <div class="neumorphic-card p-6 rounded-2xl w-full max-w-lg relative max-h-[90vh] flex flex-col">
                        <h3 class="text-2xl font-bold mb-4">Resumen de tu Pedido</h3>
                        <div id="cart-summary-items" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
                        <div id="shipping-options" class="mt-4 border-t pt-4"></div>
                        <div id="order-summary-total" class="mt-4 border-t pt-4 font-semibold"></div>
                        <div class="mt-6 flex justify-end gap-4">
                            <button id="close-order-modal-btn" class="btn bg-gray-200 text-gray-700 px-6 py-2 rounded-full">Cerrar</button>
                            <button id="confirm-whatsapp-btn" class="btn bg-green-500 text-white px-6 py-2 rounded-full flex items-center gap-2"><i class="fab fa-whatsapp"></i>Confirmar y Pedir</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCartButton() {
            const count = Object.values(shoppingCart).reduce((sum, qty) => sum + qty, 0);
            const container = $('cart-button-container');
            if (count > 0) {
                container.innerHTML = `
                    <div id="cart-button">
                        <button id="view-cart-btn" class="btn bg-blue-500 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-2xl">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="cart-count" class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">${count}</span>
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        function openOrderModal() {
            const itemsContainer = $('cart-summary-items');
            const shippingContainer = $('shipping-options');
            const totalContainer = $('order-summary-total');
            itemsContainer.innerHTML = '<p class="text-gray-500">Tu carrito está vacío.</p>';

            if (Object.keys(shoppingCart).length === 0) return;

            itemsContainer.innerHTML = '';
            let subtotal = 0;
            let totalWeight = 0;

            for (const [productId, quantity] of Object.entries(shoppingCart)) {
                const product = products.find(p => p.idLocal === productId);
                if (!product) continue;

                const price = selectedShippingMethod === 'air' ? product.precio_final_aereo : product.precio_final_maritimo;
                const itemTotal = price * quantity;
                subtotal += itemTotal;
                totalWeight += (product.peso_lb || 0) * quantity;

                itemsContainer.innerHTML += `
                    <div class="flex justify-between items-center text-sm border-b pb-2">
                        <div>
                            <p class="font-bold">${escapeHTML(product.nombre)} (x${quantity})</p>
                            <p class="text-xs text-gray-500">Peso: ${(product.peso_lb * quantity).toFixed(2)} lb</p>
                        </div>
                        <p class="font-semibold">${store.currency} ${itemTotal.toFixed(2)}</p>
                    </div>
                `;
            }

            if (store.storeType === 'by_order' && store.isLogisticsDual) {
                shippingContainer.innerHTML = `
                    <p class="font-bold mb-2 text-sm">Método de Envío Preferido:</p>
                    <div class="flex gap-4 text-sm">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="shipping" value="air" ${selectedShippingMethod === 'air' ? 'checked' : ''}> Aéreo</label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="shipping" value="sea" ${selectedShippingMethod === 'sea' ? 'checked' : ''}> Marítimo</label>
                    </div>
                `;
            } else {
                shippingContainer.innerHTML = '';
            }

            const deliveryText = getCustomerDeliveryText();
            const deliveryCost = getDeliveryCost();
            const grandTotal = subtotal + deliveryCost;

            totalContainer.innerHTML = `
                <div class="space-y-1 text-sm">
                    <p class="flex justify-between"><span>Subtotal:</span> <span>${store.currency} ${subtotal.toFixed(2)}</span></p>
                    <p class="flex justify-between"><span>Peso Total Estimado:</span> <span>${totalWeight.toFixed(2)} lb</span></p>
                    <p class="flex justify-between"><span>Costo de Delivery:</span> <span>${deliveryText.includes('Retiro') || deliveryText.includes('incluído') ? deliveryText : `${store.currency} ${deliveryCost.toFixed(2)}`}</span></p>
                    <p class="flex justify-between text-xl font-bold border-t pt-2 mt-2"><span>Total a Pagar (aprox):</span> <span>${store.currency} ${grandTotal.toFixed(2)}</span></p>
                </div>
            `;

            $('order-modal').classList.remove('hidden');
        }

        function handleCartAction(productId, action) {
            let quantity = shoppingCart[productId] || 0;
            if (action === 'add') quantity++;
            if (action === 'remove' && quantity > 0) quantity--;
            
            if (quantity === 0) delete shoppingCart[productId];
            else shoppingCart[productId] = quantity;

            renderCartButton();
        }

        function generateWhatsAppMessage() {
            const greeting = (() => {
                const hour = new Date().getHours();
                if (hour < 12) return 'Buenos días';
                if (hour < 18) return 'Buenas tardes';
                return 'Buenas noches';
            })();

            let message = `${greeting}, quiero hacer un pedido de la tienda "${store.nombre}":\n\n`;
            let subtotal = 0, totalWeight = 0;

            for (const [productId, quantity] of Object.entries(shoppingCart)) {
                const product = products.find(p => p.idLocal === productId);
                if (!product) continue;
                const price = selectedShippingMethod === 'air' ? product.precio_final_aereo : product.precio_final_maritimo;
                const itemTotal = price * quantity;
                subtotal += itemTotal;
                totalWeight += (product.peso_lb || 0) * quantity;
                message += `- ${product.nombre} (x${quantity}) - ${store.currency} ${itemTotal.toFixed(2)}\n`;
            }

            const deliveryCost = getDeliveryCost();
            const grandTotal = subtotal + deliveryCost;

            if (store.storeType === 'by_order' && store.isLogisticsDual) {
                message += `\n*Método de Envío Preferido:* ${selectedShippingMethod === 'air' ? 'Aéreo' : 'Marítimo'}\n`;
            }
            message += `*Subtotal:* ${store.currency} ${subtotal.toFixed(2)}\n`;
            message += `*Costo de Delivery:* ${store.currency} ${deliveryCost.toFixed(2)}\n`;
            message += `*Total a Pagar (aprox):* ${store.currency} ${grandTotal.toFixed(2)}\n`;
            message += `*Peso Total Estimado:* ${totalWeight.toFixed(2)} lb`;

            const phoneNumber = store.whatsapp.replace(/\s+|-/g, '');
            const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function attachGlobalListeners() {
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('#view-cart-btn')) openOrderModal();
                if (e.target.closest('#close-order-modal-btn')) $('order-modal').classList.add('hidden');
                if (e.target.closest('#confirm-whatsapp-btn')) generateWhatsAppMessage();
            });
            document.body.addEventListener('change', (e) => {
                if (e.target.name === 'shipping') {
                    selectedShippingMethod = e.target.value;
                    openOrderModal();
                }
            });
        }
        
        function getCustomerPriceAndDelivery(p) {
            const c = store.currency || 'USD';
            if (store.storeType === 'in_stock') {
                const price = p.precio_base || 0;
                return { 
                    price: `<div class="font-bold text-3xl text-indigo-700">${c} ${price.toFixed(2)}</div>`, 
                    time: `<div class="text-sm text-green-600 font-semibold"><i class="fas fa-boxes"></i> Entrega Inmediata</div>` 
                };
            }

            const shippingMethods = [];
            if (store.isLogisticsDual) {
                shippingMethods.push({ method: 'AÉREO', price: `${c} ${(p.precio_final_aereo || 0).toFixed(2)}`, days: `${store.airMinDays}-${store.airMaxDays} días` });
                shippingMethods.push({ method: 'MARÍTIMO', price: `${c} ${(p.precio_final_maritimo || 0).toFixed(2)}`, days: `${store.seaMinDays}-${store.seaMaxDays} días` });
            } else {
                shippingMethods.push({ method: 'Precio Base', price: `${c} ${(p.precio_final_aereo || 0).toFixed(2)}`, days: 'Consultar' });
            }
            
            const priceDisplay = shippingMethods.map(m => `<div class="font-bold text-xl flex justify-between items-center text-gray-800"><span class="${m.method.includes('AÉREO') ? 'text-blue-700' : 'text-green-700'}">${m.method}:</span> <span>${m.price}</span></div>`).join('');
            const timeDisplay = shippingMethods.map(m => `<div class="text-sm text-gray-600 flex justify-between"><span><i class="fas ${m.method.includes('AÉREO') ? 'fa-plane' : 'fa-ship'} mr-1"></i> ${m.method}:</span> <span class="font-semibold">${m.days}</span></div>`).join('');
            
            return { 
                price: `<div class="space-y-1">${priceDisplay}</div>`, 
                time: `<div class="space-y-1 p-2 bg-gray-100 rounded-lg">${timeDisplay}</div>` 
            };
        }

        function getDeliveryCost() {
            if (store.delivery_type === 'fixed') return store.delivery_fixed_cost || 0;
            if (store.delivery_type === 'range') return store.delivery_range_end || 0;
            return 0;
        }

        function getCustomerDeliveryText() {
            if (store.delivery_type === 'no') return `<span class="text-red-500 font-semibold"><i class="fas fa-ban"></i> Retiro en tienda.</span>`;
            
            let costText = '';
            if (store.delivery_type === 'included') costText = `<span class="text-green-600 font-semibold">Envío incluído.</span>`;
            else if (store.delivery_type === 'fixed') costText = `Delivery Fijo: ${store.currency} ${(store.delivery_fixed_cost || 0).toFixed(2)}`;
            else if (store.delivery_type === 'range') costText = `Delivery Aprox: ${store.currency} ${(store.delivery_range_start || 0).toFixed(2)} - ${store.currency} ${(store.delivery_range_end || 0).toFixed(2)}`;
            
            let noteText = store.delivery_note ? `<span class="text-xs text-gray-500 block">(${escapeHTML(store.delivery_note)})</span>` : '';
            return `<span class="text-blue-600"><i class="fas fa-truck"></i> ${costText}</span>${noteText}`;
        }

        window.handleCartAction = handleCartAction;

    } catch (e) {
        const errorMsg = `FATAL ERROR: ${e.message}`;
        console.error(errorMsg, { stack: e.stack });
        const storeContainer = document.getElementById('store-container');
        if(storeContainer) storeContainer.innerHTML = `<h1 class="text-center text-2xl font-bold text-red-500">${errorMsg}</h1>`;
    }
  </script>
</body>
</html>