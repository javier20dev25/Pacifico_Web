<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root { --bg: #e9eef6; --card: #f6f8fb; --muted: #6b7280; --accent: #7ea1ff; }
    html, body { scroll-behavior: smooth; }
    body { background: linear-gradient(180deg, #e9eef6, #dfe8f8); font-family: 'Inter', sans-serif; color: #1a202c; }
    .neumorphic-card { background: var(--card); border-radius: 14px; box-shadow: 8px 8px 20px rgba(170, 187, 204, 0.18), -8px -8px 20px rgba(255, 255, 255, 0.9); }
    .btn { transition: transform 0.12s ease-in-out, box-shadow 0.12s ease-in-out; }
    .btn:active { transform: translateY(1px); box-shadow: none; }
    .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
    .tag-item { background-color: var(--accent); color: white; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem; }
    #cart-button-container { position: fixed; bottom: 20px; right: 20px; z-index: 40; }
    #cart-count { position: absolute; top: -5px; right: -5px; background-color: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Inyección de datos del servidor -->
  __DATA_INJECTION_POINT__

  <!-- Contenedor principal de la tienda -->
  <div id="store-container" class="container mx-auto p-4 md:p-6 lg:p-8"></div>

  <!-- Botón del carrito flotante -->
  <div id="cart-button-container"></div>

  <!-- Modales -->
  <div id="modals-container"></div>

  <script type="module">
    // --- ESTADO GLOBAL ---
    let store = {};
    let products = [];
    let shoppingCart = {};
    
    // --- FUNCIONES DE UTILIDAD ---
    const $ = id => document.getElementById(id);
    const escapeHTML = (s) => (s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]);

    function getPublicImageUrl(pathOrUrl) {
        if (!pathOrUrl) return 'https://placehold.co/400x300/f6f8fb/6b7280?text=IMG';
        if (pathOrUrl.startsWith('http') || pathOrUrl.startsWith('data:')) return pathOrUrl;
        const config = window.SUPABASE_CONFIG;
        if (!config || !config.url || !config.bucket) {
            console.error("Supabase config is missing or incomplete.", config);
            return 'https://placehold.co/400x300/f6f8fb/ff0000?text=CONFIG_ERROR';
        }
        const supabaseUrl = config.url.endsWith('/') ? config.url : `${config.url}/`;
        return `${supabaseUrl}storage/v1/object/public/${config.bucket}/${pathOrUrl}`;
    }

    // --- LÓGICA DE RENDERIZADO ---
    function renderStoreView() {
        document.title = store.nombre || 'Tienda';
        const storeContainer = $('store-container');
        
        const storeLogoUrl = getPublicImageUrl(store.logoUrl);
        
        const headerHtml = `
          <div class="text-center mb-6">
              <img src="${storeLogoUrl}" class="w-20 h-20 rounded-full object-cover mx-auto mb-2 neumorphic-card" alt="Logo de la tienda">
              <h3 class="text-2xl font-bold text-gray-800">${escapeHTML(store.nombre || 'Tienda Sin Nombre')}</h3>
              <p class="text-sm text-gray-600 mt-1">${escapeHTML(store.descripcion)}</p>
              <div class="flex justify-center items-center mt-2">
                ${store.whatsapp ? `<a href="https://wa.me/${store.whatsapp.replace(/\s+|-/g, '')}" target="_blank" class="text-teal-600 text-xs font-semibold inline-flex items-center"><i class="fab fa-whatsapp mr-1"></i> Contactar</a>` : ''}
              </div>
          </div>`;
        
        const productsHtml = products.map((p) => {
            const productImageUrl = getPublicImageUrl(p.imageUrl);
            const id = p.idLocal;
            const { price: priceDisplay, time: timeDisplay } = getCustomerPriceAndDelivery(p);

            return `
              <div class="neumorphic-card p-4 flex flex-col gap-3" data-id="${id}">
                  <div class="relative">
                    <img src="${productImageUrl}" class="w-full h-48 rounded-lg object-cover" alt="${escapeHTML(p.nombre)}">
                  </div>
                  <div class="flex-1">
                      <h5 class="text-lg font-bold text-gray-800">${escapeHTML(p.nombre || 'Producto sin nombre')}</h5>
                      <p class="text-xs text-gray-500 line-clamp-2 mt-1">${escapeHTML(p.descripcion || 'Sin descripción.')}</p>
                  </div>
                  <div class="border-t border-gray-100 pt-3 space-y-2">
                      ${priceDisplay}
                      <div class="text-xs text-gray-600 font-semibold pt-1">Tiempos de Entrega Estimados:</div>
                      ${timeDisplay}
                  </div>
                  <button data-action="add-to-cart" data-product-id="${id}" class="btn bg-teal-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-teal-600 text-sm flex items-center justify-center mt-auto"><i class="fas fa-cart-plus mr-2"></i> Añadir al Carrito</button>
              </div>
          `;
        }).join('');

        storeContainer.innerHTML = `
          <div class="text-left">
            ${headerHtml}
            <h4 class="text-xl font-bold mt-8 mb-4 border-t pt-4">Catálogo de Productos</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${productsHtml}</div>
          </div>`;
    }

    function getCustomerPriceAndDelivery(p) {
        const c = store.currency || 'USD';
        if (store.storeType === 'in_stock') {
            return { price: `<div class="font-bold text-3xl text-indigo-700">${c} ${(p.precio_base || 0).toFixed(2)}</div>`, time: `<div class="text-sm text-green-600 font-semibold"><i class="fas fa-boxes"></i> Entrega Inmediata</div>` };
        }
        const shippingMethods = [];
        if (store.isLogisticsDual) {
            shippingMethods.push({ method: 'AÉREO', price: `${c} ${(p.precio_final_aereo || 0).toFixed(2)}`, days: `${store.airMinDays}-${store.airMaxDays} días` });
            shippingMethods.push({ method: 'MARÍTIMO', price: `${c} ${(p.precio_final_maritimo || 0).toFixed(2)}`, days: `${store.seaMinDays}-${store.seaMaxDays} días` });
        } else {
            shippingMethods.push({ method: 'Precio Base', price: `${c} ${(p.precio_final_aereo || 0).toFixed(2)}`, days: 'Consultar' });
        }
        const priceDisplay = shippingMethods.map(m => `<div class="font-bold text-xl flex justify-between items-center text-gray-800"><span class="${m.method.includes('AÉREO') ? 'text-blue-700' : 'text-green-700'}">${m.method}:</span> <span>${m.price}</span></div>`).join('');
        const timeDisplay = shippingMethods.map(m => `<div class="text-sm text-gray-600 flex justify-between"><span><i class="fas ${m.method.includes('AÉREO') ? 'fa-plane' : 'fa-ship'} mr-1"></i> ${m.method}:</span> <span class="font-semibold">${m.days}</span></div>`).join('');
        return { price: `<div class="space-y-1">${priceDisplay}</div>`, time: `<div class="space-y-1 p-2 bg-gray-100 rounded-lg">${timeDisplay}</div>` };
    }

    function handleCartAction(productId, action) {
        console.log(`[CARRITO] Acción: ${action}, Producto ID: ${productId}`);
    }

    // --- MANEJADOR DE EVENTOS GLOBAL ---
    function attachGlobalListeners() {
        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            
            if (action === 'add-to-cart') {
                const productId = target.dataset.productId;
                if (productId) {
                    handleCartAction(productId, 'add');
                }
            }
        });
    }
    
    // --- PUNTO DE ENTRADA ---
    function main() {
        if (!window.STORE_DATA || !window.STORE_DATA.store) {
          console.error('FATAL: STORE_DATA no está disponible.');
          return;
        }
        store = window.STORE_DATA.store;
        products = window.STORE_DATA.products || [];

        renderStoreView();
        attachGlobalListeners();
    }

    main();
  </script>
</body>
</html>