<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda Online Premium - Catálogo</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Inyección de datos del servidor -->
    __DATA_INJECTION_POINT__

    <style>
        /* Configuramos la fuente Inter para un look limpio y profesional */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7fa; /* Un fondo ligeramente azulado para tranquilidad */
        }
        /* Estilo para un efecto de card flotante con sombra elegante */
        .product-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* Degradado de Confianza para el Header */
        .header-gradient {
            background: linear-gradient(180deg, #6366f1 0%, #a855f7 100%); /* Índigo a Púrpura */
        }
    </style>
</head>
<body class="pb-24">

    <!-- Header / Barra de Navegación Simple -->
    <header id="store-header" class="w-full py-4 mb-10 text-center">
        <!-- Contenido eliminado para evitar duplicados -->
    </header>

    <!-- Contenido Principal: Cabecera del Vendedor -->
    <div id="vendor-profile" class="max-w-7xl mx-auto mb-12 text-center p-6 bg-white rounded-2xl shadow-lg border-t-4 border-indigo-500">
        <!-- El contenido se generará dinámicamente -->
    </div>
    
    <!-- Sección del Catálogo -->
    <div class="max-w-7xl mx-auto px-4">
        <h3 id="catalog-title" class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-indigo-100 pb-2">
            Catálogo de Productos
        </h3>

        <!-- GRID DE PRODUCTOS (Responsive) -->
        <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Las tarjetas de producto se generarán dinámicamente -->
        </div>
    </div>

    <!-- Botón del Carrito Flotante -->
    <div id="cart-button-container">
        <!-- El botón se generará dinámicamente -->
    </div>

    <!-- Modal Universal para Medios -->
    <div id="media-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="media-modal-content" class="relative p-4">
            <!-- Contenido (imagen o iframe) se inyectará aquí -->
        </div>
        <button id="media-modal-close" class="absolute top-4 right-4 text-white text-4xl font-bold">&times;</button>
    </div>

    <script type="module">
      // --- ESTADO GLOBAL ---
      let store = {};
      let products = [];
      let shoppingCart = {}; // { productId: quantity }

      // --- FUNCIONES DE UTILIDAD ---
      const $ = id => document.getElementById(id);
      const escapeHTML = (s) => (s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]);

      function getPublicImageUrl(pathOrUrl) {
        if (!pathOrUrl) return 'https://placehold.co/400x300/f4f7fa/6b7280?text=IMG';
        if (pathOrUrl.startsWith('http') || pathOrUrl.startsWith('data:')) return pathOrUrl;
        const config = window.SUPABASE_CONFIG;
        if (!config || !config.url || !config.bucket) {
            console.error("Supabase config is missing or incomplete.", config);
            return 'https://placehold.co/400x300/f4f7fa/ff0000?text=CONFIG_ERROR';
        }
        const supabaseUrl = config.url.endsWith('/') ? config.url : `${config.url}/`;
        return `${supabaseUrl}storage/v1/object/public/${config.bucket}/${pathOrUrl}`;
      }

      function getEmbedUrl(url) {
        if (!url) return null;
        let embedUrl = null;
        if (url.includes('youtube.com/watch?v=')) {
            const videoId = url.split('watch?v=')[1].split('&')[0];
            embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        } else if (url.includes('youtu.be/')) {
            const videoId = url.split('youtu.be/')[1].split('?')[0];
            embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        }
        return embedUrl;
      }

      // --- LÓGICA DEL MODAL ---
      function openMediaModal(type, url) {
        const modal = $('media-modal');
        const contentContainer = $('media-modal-content');
        
        if (type === 'image') {
            contentContainer.innerHTML = `<img src="${url}" class="max-w-[90vw] max-h-[80vh] rounded-lg shadow-xl" />`;
            modal.classList.remove('hidden');
        } else if (type === 'video') {
            const embedUrl = getEmbedUrl(url);
            if (embedUrl) {
                contentContainer.innerHTML = `<iframe width="560" height="315" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="rounded-lg shadow-xl bg-black max-w-[90vw] max-h-[80vh]"></iframe>`;
                modal.classList.remove('hidden');
            } else {
                window.open(url, '_blank');
            }
        }
      }

      function closeMediaModal() {
        const modal = $('media-modal');
        const contentContainer = $('media-modal-content');
        modal.classList.add('hidden');
        contentContainer.innerHTML = ''; // Detiene la reproducción del video
      }

      // --- LÓGICA DE RENDERIZADO ---

      function renderHeader() {
        // El header ahora está vacío, el carrito es flotante.
        const headerContainer = $('store-header');
        headerContainer.innerHTML = ''; // Limpiamos el header
        
        // Renderizamos el botón del carrito en su nuevo contenedor flotante
        const cartContainer = $('cart-button-container');
        cartContainer.innerHTML = `
            <button id="cart-button" class="fixed bottom-5 right-5 w-16 h-16 bg-indigo-500 text-white rounded-full font-semibold text-sm hover:bg-indigo-600 transition shadow-lg flex items-center justify-center z-40">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white">0</span>
            </button>
        `;
      }

      function renderVendorProfile() {
        const profileContainer = $('vendor-profile');
        const logoUrl = getPublicImageUrl(store.logoUrl);
        const storeName = store.nombre || 'Tienda Ejemplo';
        const description = store.descripcion || 'La mejor selección de productos de calidad garantizada.';
        
        const contactButton = store.whatsapp ? `
            <a href="https://wa.me/${store.whatsapp.replace(/\s+|-/g, '')}" target="_blank" class="text-indigo-600 font-semibold hover:text-indigo-700 transition flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-2 4v7a2 2 0 01-2 2H7a2 2 0 01-2-2v-7"></path></svg>
                Contactar
            </a>` : '';

        const videoButton = store.youtubeLink ? `
            <a href="#" data-action="view-media" data-type="video" data-url="${escapeHTML(store.youtubeLink)}" class="text-purple-600 font-semibold hover:text-purple-700 transition flex items-center">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                Ver Video
            </a>` : '';

        profileContainer.innerHTML = `
          <div class="flex flex-col items-center">
              <div class="w-20 h-20 rounded-full header-gradient flex items-center justify-center mb-3 overflow-hidden">
                  <img src="${logoUrl}" alt="Logo de ${escapeHTML(storeName)}" class="w-full h-full object-cover cursor-pointer" data-action="view-media" data-type="image" data-url="${logoUrl}">
              </div>
              <h2 class="text-3xl font-extrabold text-gray-800">
                  ${escapeHTML(storeName)}
              </h2>
              <p class="text-gray-500 text-lg mt-1">
                  ${escapeHTML(description)}
              </p>
              <div class="flex items-center justify-center space-x-6 mt-4">
                ${contactButton}
                ${videoButton}
              </div>
          </div>
        `;
      }

      function renderProducts() {
        const gridContainer = $('products-grid');
        if (!products || products.length === 0) {
            gridContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay productos en esta tienda todavía.</p>';
            return;
        }
        gridContainer.innerHTML = products.map(renderProductCard).join('');
      }

      function renderProductCard(product) {
        const imageUrl = getPublicImageUrl(product.imageUrl);
        const id = product.idLocal;
        const c = store.currency || 'USD';

        // Precios
        let pricesHtml = '';
        if (store.storeType === 'in_stock') {
            pricesHtml = `<div class="flex justify-between items-end">
                            <span class="text-base font-semibold text-gray-700 uppercase">Precio:</span>
                            <span class="text-2xl font-extrabold text-indigo-800">${c} ${(product.precio_base || 0).toFixed(2)}</span>
                          </div>`;
        } else {
            pricesHtml = `
              <div class="flex justify-between items-end border-b pb-2 mb-2">
                  <span class="text-base font-semibold text-blue-600 uppercase">AÉREO:</span>
                  <span class="text-2xl font-extrabold text-blue-800">${c} ${(product.precio_final_aereo || 0).toFixed(2)}</span>
              </div>
              <div class="flex justify-between items-end">
                  <span class="text-base font-semibold text-green-600 uppercase">MARÍTIMO:</span>
                  <span class="text-xl font-bold text-green-700">${c} ${(product.precio_final_maritimo || 0).toFixed(2)}</span>
              </div>
            `;
        }

        // Tiempos de entrega
        let deliveryHtml = '';
        if (store.storeType === 'in_stock') {
            deliveryHtml = `<div class="flex items-center text-green-600"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span class="font-medium">Disponible</span></div>`;
        } else {
            deliveryHtml = `
              <div class="flex items-center text-blue-600">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                  <span class="font-medium">AÉREO:</span>
                  <span class="ml-auto text-gray-600 font-bold">${store.airMinDays || '7'}-${store.airMaxDays || '15'} días</span>
              </div>
              <div class="flex items-center text-green-600">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                  <span class="font-medium">MARÍTIMO:</span>
                  <span class="ml-auto text-gray-600 font-bold">${store.seaMinDays || '30'}-${store.seaMaxDays || '45'} días</span>
              </div>
            `;
        }

        const videoButtonHtml = product.youtubeLink ? `
          <button data-action="view-media" data-type="video" data-url="${escapeHTML(product.youtubeLink)}" class="flex-1 px-4 py-3 bg-purple-500 text-white rounded-lg font-bold hover:bg-purple-600 transition transform hover:scale-[1.02] shadow-md shadow-purple-300">
              <svg class="w-5 h-5 inline-block mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
              Ver Video
          </button>` : '';

        return `
          <div class="product-card bg-white rounded-xl overflow-hidden p-5 flex flex-col justify-between" data-product-id="${id}">
              <div>
                  <div class="h-48 bg-gray-100 rounded-lg mb-4 flex items-center justify-center border border-gray-200 overflow-hidden">
                      <img src="${imageUrl}" alt="Imagen de ${escapeHTML(product.nombre)}" class="w-full h-full object-cover cursor-pointer" data-action="view-media" data-type="image" data-url="${imageUrl}">
                  </div>
                  <h4 class="text-xl font-bold text-gray-800">${escapeHTML(product.nombre)}</h4>
                  <p class="text-sm text-gray-500 mb-4">${escapeHTML(product.descripcion)}</p>
                  <div class="mb-4">
                      ${pricesHtml}
                  </div>
                  <p class="text-xs font-semibold text-gray-700 mb-3">Tiempos de Entrega Estimados:</p>
                  <div class="space-y-1 text-sm mb-6">
                      ${deliveryHtml}
                  </div>
              </div>
              <div class="flex space-x-3 pt-4 border-t border-gray-100">
                  <div id="add-to-cart-container-${id}" class="flex-1">
                      <button data-action="add-to-cart" data-product-id="${id}" class="w-full px-4 py-3 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 transition transform hover:scale-[1.02] shadow-md shadow-green-300">
                          <svg class="w-5 h-5 inline-block mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                          Añadir
                      </button>
                  </div>
                  ${videoButtonHtml}
              </div>
          </div>
        `;
      }

      // --- LÓGICA DEL CARRITO ---

      function handleCartClick(productId, operation) {
        const currentQuantity = shoppingCart[productId] || 0;

        if (operation === 'add') {
            if (currentQuantity === 0) {
                shoppingCart[productId] = 1;
            }
        } else if (operation === 'increment') {
            shoppingCart[productId] = currentQuantity + 1;
        } else if (operation === 'decrement') {
            if (currentQuantity > 1) {
                shoppingCart[productId] = currentQuantity - 1;
            } else {
                delete shoppingCart[productId];
            }
        }
        
        updateProductButton(productId);
        updateCartTotal();
      }

      function updateProductButton(productId) {
        const container = $(`add-to-cart-container-${productId}`);
        if (!container) return;

        const quantity = shoppingCart[productId];

        if (!quantity) {
            container.innerHTML = `
              <button data-action="add-to-cart" data-product-id="${productId}" class="w-full px-4 py-3 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 transition transform hover:scale-[1.02] shadow-md shadow-green-300">
                  <svg class="w-5 h-5 inline-block mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                          Añadir
                      </button>
            `;
        } else {
            container.innerHTML = `
              <div class="flex items-center justify-center w-full">
                  <button data-action="decrement" data-product-id="${productId}" class="px-4 py-3 bg-gray-300 text-gray-800 rounded-l-lg font-bold hover:bg-gray-400 transition">-</button>
                  <span class="px-4 py-3 bg-gray-100 text-gray-800 font-bold text-lg">${quantity}</span>
                  <button data-action="increment" data-product-id="${productId}" class="px-4 py-3 bg-gray-300 text-gray-800 rounded-r-lg font-bold hover:bg-gray-400 transition">+</button>
              </div>
            `;
        }
      }

      function updateCartTotal() {
          const cartCount = $('cart-count');
          if (!cartCount) return;

          const totalItems = Object.values(shoppingCart).reduce((sum, quantity) => sum + quantity, 0);
          
          cartCount.textContent = totalItems;
          cartCount.classList.toggle('hidden', totalItems === 0);
      }


      // --- MANEJADOR DE EVENTOS ---
      function attachEventListeners() {
          document.body.addEventListener('click', function(event) {
              const target = event.target.closest('[data-action]');
              if (!target) return;

              const action = target.dataset.action;
              const productId = target.dataset.productId;
              const url = target.dataset.url;
              const type = target.dataset.type;

              switch(action) {
                case 'add-to-cart':
                  handleCartClick(productId, 'add');
                  break;
                case 'increment':
                  handleCartClick(productId, 'increment');
                  break;
                case 'decrement':
                  handleCartClick(productId, 'decrement');
                  break;
                case 'view-media':
                  if (url && type) openMediaModal(type, url);
                  break;
              }
          });

          $('media-modal-close').addEventListener('click', closeMediaModal);
          $('media-modal').addEventListener('click', function(event) {
              if (event.target.id === 'media-modal') {
                  closeMediaModal();
              }
          });
      }

      // --- PUNTO DE ENTRADA ---
      function main() {
        if (!window.STORE_DATA || !window.STORE_DATA.store) {
          console.error('FATAL: STORE_DATA no está disponible o está malformado.');
          document.body.innerHTML = '<p class="text-red-500 text-center mt-10">Error: No se pudieron cargar los datos de la tienda.</p>';
          return;
        }
        store = window.STORE_DATA.store;
        products = window.STORE_DATA.products || [];

        renderHeader();
        renderVendorProfile();
        renderProducts();
        attachEventListeners();
        updateCartTotal(); // Para asegurar que el contador inicie en 0 y oculto
      }

      document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>