<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda</title>
  <!-- Tailwind CSS será inyectado por Vite en modo de desarrollo o incluido en el build -->
  <link rel="stylesheet" href="/src/index.css"> <!-- Se asume que Vite/Rollup generará este archivo -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    html, body { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; color: #1a202c; background-color: #e0e0e0; } /* Fondo base neomórfico */
    .btn {
      transition: all 0.2s ease-in-out;
      box-shadow: 6px 6px 12px #a7a7a7, -6px -6px 12px #ffffff; /* Sombra neomórfica por defecto */
      background-color: #e0e0e0; /* Color de fondo neomórfico */
      border-radius: 14px;
    }
    .btn:hover {
      box-shadow: 3px 3px 6px #a7a7a7, -3px -3px 6px #ffffff; /* Ligero hundimiento al pasar el ratón */
    }
    .btn:active {
      box-shadow: inset 2px 2px 5px #a7a7a7, inset -2px -2px 5px #ffffff; /* Efecto hundido al hacer clic */
    }
    .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
    .tag-item { background-color: #f0f0f0; color: #4a4a4a; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem; border: 1px solid #d0d0d0; }
    #cart-button-container { position: fixed; bottom: 20px; right: 20px; z-index: 40; }
    #cart-count { position: absolute; top: -5px; right: -5px; background-color: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; }

    /* Estilos para el iframe de YouTube responsivo */
    .video-responsive {
      overflow: hidden;
      padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
      position: relative;
      height: 0;
    }
    .video-responsive iframe {
      left: 0;
      top: 0;
      height: 100%;
      width: 100%;
      position: absolute;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-neumoBg text-gray-800">

  <!-- Inyección de datos del servidor -->
  <!-- SERVER_DATA_INJECTION -->

  <!-- Contenedor principal de la tienda -->
  <div id="store-container" class="container mx-auto p-4 md:p-6 lg:p-8">

  </div>

  <!-- Botón del carrito flotante -->
  <div id="cart-button-container"></div>

  <!-- Modales -->
  <div id="modals-container"></div>

  <script type="module">
    // ==========================================================
    // ESTADO Y CONFIGURACIÓN GLOBAL
    // ==========================================================
    let store = {};
    let products = [];
    let shoppingCart = {}; // Formato: { productId: quantity }
    let selectedShippingMethod = 'air'; // 'air' o 'sea'

    const $ = id => document.getElementById(id);
    const escapeHTML = (s) => (s || '').replace(/[&<"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]);

    // ==========================================================
    // HELPERS
    // ==========================================================
    function getYouTubeEmbedUrl(url) {
      if (!url) return null;
      const regExp = /^(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([^\&\?]*)/;
      const match = url.match(regExp);
      return match && match[1] ? `https://www.youtube.com/embed/${match[1]}` : null;
    }

    // ==========================================================
    // INICIALIZACIÓN
    // ==========================================================
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof window.STORE_DATA === 'undefined' || !window.STORE_DATA.store || !window.STORE_DATA.products) {
        $('store-container').innerHTML = '<h1 class="text-center text-2xl font-bold text-red-500">Error: No se pudieron cargar los datos de la tienda.</h1>';
        return;
      }
      store = window.STORE_DATA.store;
      products = window.STORE_DATA.products;
      
      renderStoreView();
      renderModals();
      renderCartButton();
      attachGlobalListeners();
    });

    // ==========================================================
    // FUNCIONES DE RENDERIZADO
    // ==========================================================

    function renderStoreView() {
        document.title = store.nombre || 'Tienda';
        const storeContainer = $('store-container');
        const storeNameVal = store.nombre || 'Tienda Sin Nombre';
        const storeLogoUrl = store.logoUrl || 'https://placehold.co/80x80/e0e0e0/a7a7a7?text=LOGO';
        
        let headerHtml = `
            <div class="text-center mb-6">
                <img src="${storeLogoUrl}" class="w-24 h-24 rounded-full object-cover mx-auto mb-4 shadow-neumo" alt="Logo de la tienda">
                <h3 class="text-3xl font-bold text-gray-800">${escapeHTML(storeNameVal)}</h3>
                ${store.descripcion ? `<p class="text-lg text-gray-600 mt-2">${escapeHTML(store.descripcion)}</p>` : ''}
                ${store.whatsapp ? `<a href="https://wa.me/${store.whatsapp.replace(/\s+|-/g, '')}" target="_blank" class="text-emerald-600 text-base font-semibold inline-flex items-center mt-3 btn shadow-neumo-sm hover:shadow-neumo-md active:shadow-neumo-inset p-3 rounded-full"><i class="fab fa-whatsapp text-lg mr-2"></i> Contactar por WhatsApp</a>` : ''}
            </div>
        `;

        const productsHtml = products.map(p => {
            const id = p.idLocal;
            const tagsHtml = (p.tags || []).map(tag => `<span class="tag-item">#${escapeHTML(tag)}</span>`).join('');
            const { price: priceDisplay, time: timeDisplay } = getCustomerPriceAndDelivery(p);
            const deliveryNote = getCustomerDeliveryText(p);
            const youtubeEmbedUrl = getYouTubeEmbedUrl(p.youtubeLink);

            return `
                <div class="shadow-neomoc bg-neumoBg p-4 flex flex-col gap-3 rounded-xl" data-id="${id}">
                    <img src="${p.imageUrl || 'https://placehold.co/400x300/e0e0e0/a7a7a7?text=IMG'}" class="w-full h-48 rounded-lg object-cover shadow-inner-neumo mb-2" alt="${escapeHTML(p.name)}">
                    ${youtubeEmbedUrl ? `<div class="video-responsive mt-2 mb-4 rounded-lg overflow-hidden shadow-inner-neumo"><iframe src="${youtubeEmbedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>` : ''}
                    <div class="flex-1">
                        <h5 class="text-xl font-bold text-gray-800">${escapeHTML(p.name || 'Producto sin nombre')}</h5>
                        <p class="text-sm text-gray-600 line-clamp-2 mt-1">${escapeHTML(p.descripcion || 'Sin descripción.')}</p>
                    </div>
                    <div class="border-t border-gray-200 pt-3 space-y-2 mt-2">
                        ${priceDisplay}
                        <div class="text-xs text-gray-700 font-semibold pt-1">Tiempos de Entrega Estimados:</div>
                        ${timeDisplay}
                        <div class="text-sm border-t border-gray-200 pt-2 mt-2">${deliveryNote}</div>
                    </div>
                    <div class="flex flex-wrap gap-2 pt-2 border-t border-gray-200">${tagsHtml}</div>
                    <button class="btn bg-blue-500 text-white px-4 py-3 rounded-full font-semibold text-base flex items-center justify-center mt-3 shadow-neumo hover:shadow-neumo-active active:shadow-neumo-inset" onclick="handleCartAction('${id}', 'add')"><i class="fas fa-cart-plus text-lg mr-2"></i> Añadir al Carrito</button>
                </div>
            `;
        }).join('');

        storeContainer.innerHTML = `
          <div class="text-left">
            ${headerHtml}
            <h4 class="text-2xl font-bold mt-10 mb-6 pb-2 border-b-2 border-gray-300">Catálogo de Productos</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
              ${productsHtml || `<div class="text-center text-gray-500 py-10 shadow-neumo bg-neumoBg rounded-xl">No hay productos añadidos.</div>`}
            </div>
          </div>
        `;
    }

    function renderModals() {
        const modalsContainer = $('modals-container');
        modalsContainer.innerHTML = `
            <div id="order-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay hidden">
                <div class="bg-neumoBg p-8 rounded-2xl w-full max-w-lg relative max-h-[90vh] flex flex-col shadow-neumo">
                    <h3 class="text-3xl font-bold text-gray-800 mb-6">Resumen de tu Pedido</h3>
                    <div id="cart-summary-items" class="flex-grow overflow-y-auto pr-2 space-y-4 text-gray-700"></div>
                    <div id="shipping-options" class="mt-6 pt-4 border-t border-gray-200"></div>
                    <div id="order-summary-total" class="mt-6 pt-4 border-t border-gray-300 font-semibold text-lg"></div>
                    <div class="mt-8 flex justify-end gap-4">
                        <button id="close-order-modal-btn" class="btn px-6 py-3 bg-gray-300 text-gray-800 rounded-full shadow-neumo hover:shadow-neumo-active active:shadow-neumo-inset">Cerrar</button>
                        <button id="confirm-whatsapp-btn" class="btn bg-emerald-500 text-white px-6 py-3 rounded-full flex items-center gap-2 shadow-neumo hover:shadow-neumo-active active:shadow-neumo-inset"><i class="fab fa-whatsapp text-xl"></i> Confirmar por WhatsApp</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderCartButton() {
        const count = Object.values(shoppingCart).reduce((sum, qty) => sum + qty, 0);
        const container = $('cart-button-container');
        if (count > 0) {
            container.innerHTML = `
                <div id="cart-button">
                    <button id="view-cart-btn" class="btn bg-neumoBg text-blue-600 rounded-full w-20 h-20 flex items-center justify-center text-3xl shadow-neumo hover:shadow-neumo-active active:shadow-neumo-inset">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cart-count" class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full h-7 w-7 flex items-center justify-center shadow-neumo-sm">${count}</span>
                    </button>
                </div>
            `;
        } else {
            container.innerHTML = '';
        }
    }

    function openOrderModal() {
        const itemsContainer = $('cart-summary-items');
        const shippingContainer = $('shipping-options');
        const totalContainer = $('order-summary-total');

        itemsContainer.innerHTML = '';
        let subtotal = 0;
        let totalWeight = 0;
        let deliveryCosts = [];
        let hasMadeToOrder = false;

        if (Object.keys(shoppingCart).length === 0) {
          itemsContainer.innerHTML = '<p class="text-gray-500 text-center py-4 rounded-lg bg-gray-100 shadow-inner-neumo">Tu carrito está vacío. Añade productos para continuar.</p>';
          totalContainer.innerHTML = ''; // Clear total if cart is empty
          shippingContainer.innerHTML = ''; // Clear shipping if cart is empty
          $('order-modal').classList.remove('hidden');
          return;
        }

        for (const [productId, quantity] of Object.entries(shoppingCart)) {
            const product = products.find(p => p.idLocal === productId);
            if (!product) continue;

            // Aseguramos que product.productStockMode exista y sea válido
            const productStockMode = product.productStockMode || 'stock'; 
            if (productStockMode === 'by_order') hasMadeToOrder = true; // Asumo 'by_order' para productos que no son 'stock'

            // Uso de precios finales calculados en el store
            const price = store.storeType === 'by_order' 
                ? (selectedShippingMethod === 'air' ? product.precio_final_aereo : product.precio_final_maritimo) || 0
                : product.precio_base || 0;

            const itemTotal = price * quantity;
            subtotal += itemTotal;
            totalWeight += (product.peso_lb || 0) * quantity;

            // Cálculo de delivery basado en el producto (si aplica)
            if (product.delivery_type === 'fixed') deliveryCosts.push(product.delivery_fixed_cost || 0);
            if (product.delivery_type === 'range') deliveryCosts.push(product.delivery_range_end || 0);

            itemsContainer.innerHTML += `
                <div class="neumorphic-card p-3 flex justify-between items-center text-sm rounded-lg shadow-neumo-sm border border-gray-200">
                    <div>
                        <p class="font-bold text-gray-800">${escapeHTML(product.nombre)} (x${quantity})</p>
                        <p class="text-xs text-gray-500">Peso: ${((product.peso_lb || 0) * quantity).toFixed(2)} lb</p>
                    </div>
                    <p class="font-semibold text-gray-700">${store.currency} ${itemTotal.toFixed(2)}</p>
                </div>
            `;
        }

        if (hasMadeToOrder && store.isLogisticsDual) {
            shippingContainer.innerHTML = `
                <p class="font-bold mb-3 text-sm text-gray-700">Método de Envío Preferido:</p>
                <div class="flex flex-wrap gap-4 text-sm">
                    <label class="neumo-radio-label">
                      <input type="radio" name="shipping" value="air" ${selectedShippingMethod === 'air' ? 'checked' : ''} class="neumo-radio-input">
                      <span class="neumo-radio-btn">✈️ Aéreo</span>
                    </label>
                    <label class="neumo-radio-label">
                      <input type="radio" name="shipping" value="sea" ${selectedShippingMethod === 'sea' ? 'checked' : ''} class="neumo-radio-input">
                      <span class="neumo-radio-btn">🚢 Marítimo</span>
                    </label>
                </div>
            `;
        } else {
            shippingContainer.innerHTML = '';
        }

        const finalDeliveryCost = deliveryCosts.length > 0 ? Math.max(...deliveryCosts) : (store.delivery_type === 'fixed' ? store.delivery_fixed_cost : 0);
        const grandTotal = subtotal + finalDeliveryCost; // Ajustado: el delivery es total, no por producto

        totalContainer.innerHTML = `
            <div class="space-y-2 text-base">
                <p class="flex justify-between text-gray-700"><span>Subtotal:</span> <span class="font-semibold">${store.currency} ${subtotal.toFixed(2)}</span></p>
                <p class="flex justify-between text-gray-700"><span>Peso Total Estimado:</span> <span class="font-semibold">${totalWeight.toFixed(2)} lb</span></p>
                ${finalDeliveryCost > 0 ? `<p class="flex justify-between text-gray-700"><span>Costo de Delivery:</span> <span class="font-semibold">${store.currency} ${finalDeliveryCost.toFixed(2)}</span></p>` : ''}
                <p class="flex justify-between text-xl font-bold border-t-2 border-gray-300 pt-3 mt-3 text-gray-800"><span>Total a Pagar (aprox):</span> <span>${store.currency} ${grandTotal.toFixed(2)}</span></p>
            </div>
        `;

        $('order-modal').classList.remove('hidden');
    }

    // ==========================================================
    // LÓGICA DE ACCIONES
    // ==========================================================

    function handleCartAction(productId, action) {
        let quantity = shoppingCart[productId] || 0;
        if (action === 'add') quantity++;
        if (action === 'remove' && quantity > 0) quantity--;
        
        if (quantity === 0) delete shoppingCart[productId];
        else shoppingCart[productId] = quantity;

        renderCartButton();
        // Si el Modal está abierto,actualizarlo. Mejora UX.
        if (!$('order-modal').classList.contains('hidden')) {
          openOrderModal();
        }
    }

    function generateWhatsAppMessage() {
        const greeting = (() => {
            const hour = new Date().getHours();
            if (hour < 12) return 'Buenos días';
            if (hour < 18) return 'Buenas tardes';
            return 'Buenas noches';
        })();

        let message = `${greeting}, quiero hacer un pedido de la tienda "${store.nombre}":\n\n`;
        let subtotal = 0, totalWeight = 0, deliveryCosts = [];

        for (const [productId, quantity] of Object.entries(shoppingCart)) {
            const product = products.find(p => p.idLocal === productId);
            if (!product) continue;
            // Uso de precios finales calculados en el store
            const price = store.storeType === 'by_order' 
                ? (selectedShippingMethod === 'air' ? product.precio_final_aereo : product.precio_final_maritimo) || 0
                : product.precio_base || 0;

            const itemTotal = price * quantity;
            subtotal += itemTotal;
            totalWeight += (product.peso_lb || 0) * quantity;

            if (product.delivery_type === 'fixed') deliveryCosts.push(product.delivery_fixed_cost || 0);
            if (product.delivery_type === 'range') deliveryCosts.push(product.delivery_range_end || 0);
            message += `- ${product.nombre} (x${quantity}) - ${store.currency} ${itemTotal.toFixed(2)}\n`;
        }

        const finalDeliveryCost = deliveryCosts.length > 0 ? Math.max(...deliveryCosts) : (store.delivery_type === 'fixed' ? store.delivery_fixed_cost : 0);
        const grandTotal = subtotal + finalDeliveryCost;

        message += `\n*Método de Envío Preferido:* ${selectedShippingMethod === 'air' ? 'Aéreo' : 'Marítimo'}\n`;
        message += `*Subtotal:* ${store.currency} ${subtotal.toFixed(2)}\n`;
        message += `*Costo de Delivery:* ${store.currency} ${finalDeliveryCost.toFixed(2)}\n`;
        message += `*Total a Pagar (aprox):* ${store.currency} ${grandTotal.toFixed(2)}\n`;
        message += `*Peso Total Estimado:* ${totalWeight.toFixed(2)} lb`;

        const phoneNumber = store.whatsapp?.replace(/\s+|-/g, '') || '';
        const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    }

    function attachGlobalListeners() {
        document.body.addEventListener('click', (e) => {
            if (e.target.closest('#view-cart-btn')) openOrderModal();
            if (e.target.closest('#close-order-modal-btn')) $('order-modal').classList.add('hidden');
            if (e.target.closest('#confirm-whatsapp-btn')) generateWhatsAppMessage();
        });
        document.body.addEventListener('change', (e) => {
            if (e.target.name === 'shipping') {
                selectedShippingMethod = e.target.value;
                openOrderModal();
            }
        });
    }
    
    // ==========================================================
    // HELPERS (se mantienen igual)
    // ==========================================================
    function getCustomerPriceAndDelivery(p) {
        const c = store.currency;
        if (p.productStockMode === 'stock') {
            return { price: `<div class="font-bold text-3xl text-indigo-700">${c}${p.airFinalPrice.toFixed(2)}</div>`, time: `<div class="text-sm text-green-600 font-semibold"><i class="fas fa-boxes"></i> Entrega Inmediata</div>` };
        }
        const shippingMethods = [];
        if (store.isLogisticsDual) {
            if (p.prodShipMethod === 'air' || p.prodShipMethod === 'both') shippingMethods.push({ method: 'AÉREO', price: `${c}${p.airFinalPrice.toFixed(2)}`, days: `${store.airMinDays}-${store.airMaxDays} días` });
            if (p.prodShipMethod === 'sea' || p.prodShipMethod === 'both') shippingMethods.push({ method: 'MARÍTIMO', price: `${c}${p.seaFinalPrice.toFixed(2)}`, days: `${store.seaMinDays}-${store.seaMaxDays} días` });
        } else {
            shippingMethods.push({ method: 'Precio Base', price: `${c}${p.airFinalPrice.toFixed(2)}`, days: 'Consultar' });
        }
        const priceDisplay = shippingMethods.map(m => `<div class="font-bold text-xl flex justify-between items-center text-gray-800"><span class="${m.method.includes('AÉREO') ? 'text-blue-700' : 'text-green-700'}">${m.method}:</span> <span>${m.price}</span></div>`).join('');
        const timeDisplay = shippingMethods.map(m => `<div class="text-sm text-gray-600 flex justify-between"><span><i class="fas ${m.method.includes('AÉREO') ? 'fa-plane' : 'fa-ship'} mr-1"></i> ${m.method}:</span> <span class="font-semibold">${m.days}</span></div>`).join('');
        return { price: `<div class="space-y-1">${priceDisplay}</div>`, time: `<div class="space-y-1 p-2 bg-gray-100 rounded-lg">${timeDisplay}</div>` };
    }
    function getCustomerDeliveryText(p) {
        if (p.deliveryCostType === 'no') return `<span class="text-red-500 font-semibold"><i class="fas fa-ban"></i> Retiro en tienda.</span>`;
        let costText = '';
        if (p.deliveryCostType === 'included') costText = `<span class="text-green-600 font-semibold">Envío incluído.</span>`;
        else if (p.deliveryCostType === 'fixed') costText = `Delivery Fijo: ${store.currency}${(p.deliveryFixedValue || 0).toFixed(2)}`;
        else if (p.deliveryCostType === 'range') costText = `Delivery Aprox: ${store.currency}${(p.deliveryRangeStart || 0).toFixed(2)} - ${store.currency}${(p.deliveryRangeEnd || 0).toFixed(2)}`;
        let noteText = p.deliveryNote ? `<span class="text-xs text-gray-500 block">(${escapeHTML(p.deliveryNote)})</span>` : '';
        return `<span class="text-blue-600"><i class="fas fa-truck"></i> ${costText}</span>${noteText}`;
    }

    // Exponer funciones al scope global para que los botones en el HTML puedan llamarlas
    window.handleCartAction = handleCartAction;

  </script>
</body>
</html>