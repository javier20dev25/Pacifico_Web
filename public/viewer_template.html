<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --bg: #e9eef6;
      --card: #f6f8fb;
      --muted: #6b7280;
      --accent: #7ea1ff;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, #e9eef6, #dfe8f8);
      font-family: 'Inter', sans-serif;
      color: #1a202c;
    }
    .neumorphic-card {
      background: var(--card);
      border-radius: 14px;
      box-shadow: 8px 8px 20px rgba(170, 187, 204, 0.18), -8px -8px 20px rgba(255, 255, 255, 0.9);
    }
    .btn {
      transition: transform 0.12s ease-in-out, box-shadow 0.12s ease-in-out;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }
    .tag-item {
        background-color: var(--accent);
        color: white;
        padding: 4px 8px;
        border-radius: 9999px;
        font-size: 0.75rem;
    }
    .quantity-input {
        display: flex;
        align-items: center;
        width: 100px;
        background: var(--card);
        border-radius: 8px;
        box-shadow: inset 1px 1px 3px rgba(0,0,0,0.05);
    }
    .qty-btn {
        width: 30px;
        height: 30px;
        background: var(--card);
        color: #4f46e5;
        font-weight: bold;
        border-radius: 8px;
        transition: background 0.15s;
    }
    .qty-btn:active { background: #e5e9ee; }
    .qty-display {
        flex-grow: 1;
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- SERVER_DATA_INJECTION -->

  <div id="store-container" class="container mx-auto p-4 md:p-6 lg:p-8">
    <!-- El contenido de la tienda se renderizará aquí -->
  </div>

  <!-- Video Player Modal -->
  <div id="videoModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay hidden">
    <div class="neumorphic-card p-4 rounded-2xl w-full max-w-4xl relative">
      <button id="closeVideoModal" class="absolute top-4 right-4 z-10 btn bg-white text-gray-700 w-8 h-8 rounded-full shadow-lg hover:bg-gray-200"><i class="fas fa-times"></i></button>
      <div id="videoContent" class="w-full aspect-video rounded-xl overflow-hidden"></div>
      <div id="videoTitle" class="text-lg font-bold mt-3 text-center"></div>
    </div>
  </div>

  <!-- Message Modal (para el carrito) -->
  <div id="messageModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay hidden">
    <div class="neumorphic-card p-6 rounded-2xl w-full max-w-sm relative text-center">
      <div id="messageText" class="text-lg font-semibold mb-4"></div>
      <button id="messageOkBtn" class="btn bg-blue-500 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-600">OK</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof window.STORE_DATA === 'undefined' || !window.STORE_DATA.store || !window.STORE_DATA.products) {
        document.getElementById('store-container').innerHTML = '<h1 class="text-center text-2xl font-bold text-red-500">Error: No se pudieron cargar los datos de la tienda.</h1>';
        return;
      }
      
      const { store, products } = window.STORE_DATA;
      let shoppingCart = {};

      const $ = id => document.getElementById(id);
      const escapeHTML = (s) => (s || '').replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' })[c]);
      
      function getYoutubeEmbedUrl(url) {
        if (!url) return null;
        const regExp = /(?:https?:\])?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/; 
        const match = url.match(regExp);
        return match && match[1] ? `https://www.youtube.com/embed/${match[1]}?autoplay=1` : null;
      }

      const formatCurrency = (amount) => {
          if (typeof amount !== 'number' || isNaN(amount)) return '0.00';
          return amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      };

      function getCustomerDeliveryText(p) {
        if (p.deliveryCostType === 'no') return "<span class=\"text-red-500 font-semibold\"><i class=\"fas fa-ban\"></i> Retiro en tienda.</span>";
        let costText = '';
        if (p.deliveryCostType === 'included') costText = "<span class=\"text-green-600 font-semibold\">Costo de envío incluído.</span>";
        else if (p.deliveryCostType === 'fixed') costText = `Envío Fijo Local: ${store.currency}${formatCurrency(p.deliveryFixedValue || 0)}`;
        else if (p.deliveryCostType === 'range') costText = `Envío Local Aprox: ${store.currency}${formatCurrency(p.deliveryRangeStart || 0)} - ${store.currency}${formatCurrency(p.deliveryRangeEnd || 0)}`;
        let noteText = p.deliveryNote ? `<span class="text-xs text-gray-500 block">(${escapeHTML(p.deliveryNote)})</span>` : '';
        return `<span class="text-blue-600"><i class="fas fa-truck"></i> ${costText}</span>${noteText}`;
      }

      function getCustomerPriceAndDelivery(p) {
          const c = store.currency;
          if (p.productStockMode === 'stock') {
              return {
                  price: `<div class="font-bold text-3xl text-indigo-700">${c}${formatCurrency(p.airFinalPrice)}</div>`,
                  time: `<div class="text-sm text-green-600 font-semibold"><i class="fas fa-boxes"></i> Entrega Inmediata</div>`
              };
          }
          const shippingMethods = [];
          const isDual = store.isLogisticsDual;
          if (isDual) {
            if (p.prodShipMethod === 'air' || p.prodShipMethod === 'both') shippingMethods.push({ method: 'AÉREO', price: `${c}${formatCurrency(p.airFinalPrice)}`, days: `${store.airMinDays}-${store.airMaxDays} días` });
            if (p.prodShipMethod === 'sea' || p.prodShipMethod === 'both') shippingMethods.push({ method: 'MARÍTIMO', price: `${c}${formatCurrency(p.seaFinalPrice)}`, days: `${store.seaMinDays}-${store.seaMaxDays} días` });
          }
          if (!isDual || p.prodShipMethod === 'single') {
             shippingMethods.push({ method: 'Precio Base', price: `${c}${formatCurrency(p.airFinalPrice)}`, days: 'Consultar al vendedor' });
          }
          if (shippingMethods.length === 0) return { price: '<div>No disponible.</div>', time: '<div>N/A</div>' };
          const priceDisplay = shippingMethods.map(m => `<div class="font-bold text-xl flex justify-between items-center text-gray-800"><span class="${m.method.includes('AÉREO') ? 'text-blue-700' : m.method.includes('MARÍTIMO') ? 'text-green-700' : 'text-indigo-700'}">${m.method}:</span> <span>${m.price}</span></div>`).join('');
          const timeDisplay = shippingMethods.map(m => `<div class="text-sm text-gray-600 flex justify-between"><span><i class="fas ${m.method.includes('AÉREO') ? 'fa-plane' : 'fa-ship'} mr-1"></i> ${m.method}:</span> <span class="font-semibold">${m.days}</span></div>`).join('');
          return { price: `<div class="space-y-1">${priceDisplay}</div>`, time: `<div class="space-y-1 p-2 bg-gray-100 rounded-lg">${timeDisplay}</div>` };
      }

      function renderStoreView() {
        document.title = store.nombre || 'Tienda';
        const storeNameVal = store.nombre || 'Tienda Sin Nombre';
        const storeLogoUrl = store.logoUrl || 'https://placehold.co/80x80/e9eef6/6b7280?text=LOGO';
        
        let headerHtml = `
            <div class="text-center mb-6">
                <img src="${store.logoUrl || 'https://placehold.co/80x80/e9eef6/6b7280?text=LOGO'}" class="w-20 h-20 rounded-full object-cover mx-auto mb-2 neumorphic-card" alt="Logo de la tienda">
                <h3 class="text-2xl font-bold text-gray-800">${escapeHTML(storeNameVal)}</h3>
                <p class="text-sm text-gray-600 mt-1">${escapeHTML(store.descripcion)}</p>
                ${store.whatsapp ? `<a href="https://wa.me/${store.whatsapp.replace(/\s/g, '')}" target="_blank" class="text-teal-600 text-xs font-semibold inline-flex items-center mt-2"><i class="fab fa-whatsapp mr-1"></i> WhatsApp: ${store.whatsapp}</a>` : ''}
            </div>`;
        
        if (getYoutubeEmbedUrl(store.youtubeLink)) {
            headerHtml += `<div class="mb-6 p-4 rounded-xl border border-gray-200 bg-gray-50 text-center"><button class="btn bg-red-600 text-white px-4 py-2 rounded-full font-semibold hover:bg-red-700 text-sm" data-video-link="${store.youtubeLink}" data-video-title="Video Publicitario de la Tienda"><i class="fab fa-youtube mr-2"></i> Ver Video de la Tienda</button></div>`;
        }

        const productsHtml = products.map(p => {
            const id = p.idLocal;
            const tagsHtml = (p.tags || []).map(tag => `<span class="tag-item">#${escapeHTML(tag)}</span>`).join('');
            const { price: priceDisplay, time: timeDisplay } = getCustomerPriceAndDelivery(p);
            const deliveryNote = getCustomerDeliveryText(p);
            const youtubeEmbed = getYoutubeEmbedUrl(p.youtubeLink);
            const initialQty = shoppingCart[id] || 1;

            return `
                <div class="neumorphic-card p-4 flex flex-col gap-3" data-id="${id}">
                    <div class="flex items-start gap-4">
                        <img src="${p.imageUrl || 'https://placehold.co/100x100/f6f8fb/6b7280?text=IMG'}" class="w-24 h-24 rounded-lg object-cover flex-shrink-0" alt="${escapeHTML(p.name)}">
                        <div class="flex-1">
                            <h5 class="text-lg font-bold text-gray-800">${escapeHTML(p.name || 'Producto sin nombre')}</h5>
                            <p class="text-xs text-gray-500 line-clamp-2 mt-1">${escapeHTML(p.description || 'Sin descripción.')}</p>
                            ${youtubeEmbed ? `<button class="btn text-red-500 text-xs font-semibold mt-1 hover:text-red-700" onclick="openVideoModal('${youtubeEmbed}', '${escapeHTML(p.name)}')"><i class="fab fa-youtube mr-1"></i> Ver Video</button>` : ''}
                        </div>
                    </div>
                    <div class="border-t border-gray-100 pt-3 space-y-2">${priceDisplay}<div class="text-xs text-gray-600 font-semibold pt-1">Tiempos de Entrega Estimados:</div>${timeDisplay}<div class="text-sm border-t pt-2">${deliveryNote}</div></div>
                    <div class="flex flex-wrap gap-2 pt-1 border-t border-gray-100 mb-3">${tagsHtml}</div>
                    <div class="flex items-center justify-between mt-3 p-2 bg-gray-50 rounded-xl">
                        <div class="quantity-input">
                            <button class="qty-btn" onclick="handleCartAction('${id}', 'decrement', this)"><i class="fas fa-minus"></i></button>
                            <span class="qty-display">${initialQty}</span>
                            <button class="qty-btn" onclick="handleCartAction('${id}', 'increment', this)"><i class="fas fa-plus"></i></button>
                        </div>
                        <button class="btn bg-teal-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-teal-600 text-sm flex items-center" onclick="handleCartAction('${id}', 'add', this)"><i class="fas fa-cart-plus mr-2"></i> Añadir al Carrito</button>
                    </div>
                </div>`;
        }).join('');

        $('store-container').innerHTML = `<div class="text-left">${headerHtml}<h4 class="text-xl font-bold mt-8 mb-4 border-t pt-4">Catálogo de Productos</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${productsHtml || `<div class="text-center text-gray-400 py-8">No hay productos añadidos.</div>`}</div></div>`;
        
        $('store-container').querySelectorAll('[data-video-link]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const link = e.currentTarget.dataset.videoLink;
                const title = e.currentTarget.dataset.videoTitle;
                const embedUrl = getYoutubeEmbedUrl(link);
                if (embedUrl) openVideoModal(embedUrl, title);
            });
        });
      }

      window.openVideoModal = function(embedUrl, title) {
          $('videoContent').innerHTML = `<iframe width="100%" height="100%" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
          $('videoTitle').textContent = title;
          $('videoModal').classList.remove('hidden');
      };
      $('closeVideoModal').addEventListener('click', () => {
          $('videoContent').innerHTML = '';
          $('videoModal').classList.add('hidden');
      });

      function showMessageModal(title, message) {
          $('messageText').innerHTML = `<p class="font-bold text-xl mb-2">${title}</p><p>${message}</p>`;
          $('messageModal').classList.remove('hidden');
      }
      $('messageOkBtn').addEventListener('click', () => $('messageModal').classList.add('hidden'));

      window.handleCartAction = function(productId, action, element) {
          let qty = shoppingCart[productId] || 1;
          if (action === 'increment') qty++;
          else if (action === 'decrement' && qty > 1) qty--;
          shoppingCart[productId] = qty;
          if (action === 'add') {
             const productName = products.find(p => p.idLocal === productId)?.name || 'Producto';
             showMessageModal("¡Añadido al Carrito!", `${qty} unidad(es) de ${productName} ha(n) sido añadida(s) a tu carrito de compras (simulado).`);
             return;
          }
          const displayEl = element.closest('.quantity-input')?.querySelector('.qty-display');
          if (displayEl) displayEl.textContent = qty;
      }

      renderStoreView();
    });
  </script>
</body>
</html>
