<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editor de Tienda — Logística y Carrito</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --bg: #e9eef6;
      --card: #f6f8fb;
      --muted: #6b7280;
      --accent: #7ea1ff;
      --success: #35c47a;
      --danger: #ef4444;
      --warning: #facc15;
      --indigo: #4f46e5;
      --teal: #14b8a6;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, #e9eef6, #dfe8f8);
      font-family: 'Inter', sans-serif;
      color: #1a202c;
    }
    .neumorphic-card {
      background: var(--card);
      border-radius: 14px;
      box-shadow: 8px 8px 20px rgba(170, 187, 204, 0.18), -8px -8px 20px rgba(255, 255, 255, 0.9);
    }
    .btn {
      transition: transform 0.12s ease-in-out, box-shadow 0.12s ease-in-out;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .input {
      background: linear-gradient(180deg, #f7f9fc, #eef4ff);
      box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.03);
    }
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }
    .tag-item {
        background-color: var(--accent);
        color: white;
        padding: 4px 8px;
        border-radius: 9999px;
        font-size: 0.75rem;
    }
    .margin-tag {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 6px;
    }
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: var(--indigo);
    }
    input:checked + .slider:before {
        transform: translateX(26px);
    }
    .quantity-input {
        display: flex;
        align-items: center;
        width: 100px;
        background: var(--card);
        border-radius: 8px;
        box-shadow: inset 1px 1px 3px rgba(0,0,0,0.05);
    }
    .qty-btn {
        width: 30px;
        height: 30px;
        background: var(--card);
        color: var(--indigo);
        font-weight: bold;
        border-radius: 8px;
        transition: background 0.15s;
    }
    .qty-btn:active {
        background: #e5e9ee;
    }
    .qty-display {
        flex-grow: 1;
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
</head>
<body class="flex flex-col min-h-screen">
  <div class="container mx-auto p-4 md:p-6 lg:p-8">

    <!-- Header Section -->
    <header class="mb-6">
      <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 leading-tight">Editor de Tienda Profesional</h1>
      <p class="text-lg text-gray-600 mt-2">Configuración de costos, márgenes y logística.</p>
    </header>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      
      <!-- Panel de Edición -->
      <div class="flex flex-col space-y-8">
        <!-- Store Info Card -->
        <div class="neumorphic-card p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-store"></i> Información y Logística de la Tienda</h2>
          
          <div class="space-y-4 mb-6">
            <label for="storeLogoInput" class="block text-sm font-medium text-gray-500 mb-1">Logo de la Tienda (Opcional)</label>
            <div id="storeLogoDrop" class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center border border-dashed border-gray-300 cursor-pointer overflow-hidden relative shadow-inner mb-2 mx-auto" onclick="document.getElementById('storeLogoInput').click()">
                <div id="storeLogoPlaceholder" class="flex flex-col items-center text-gray-400 text-xs">
                    <i class="fas fa-camera text-xl mb-1"></i>
                </div>
                <img id="storeLogoPreview" class="w-full h-full object-cover" style="display:none" alt="store logo preview">
            </div>
            <input type="file" id="storeLogoInput" accept="image/*" class="hidden" />

            <label for="storeName" class="block text-sm font-medium text-gray-500 mb-1">Nombre de la tienda</label>
            <input id="storeName" type="text" placeholder="Ej: Tienda La Esquina" class="input w-full p-3 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" value="Mi Tienda Express"/>

            <label for="storeDescription" class="block text-sm font-medium text-gray-500 mb-1">Descripción de la tienda</label>
            <textarea id="storeDescription" placeholder="Una breve descripción de lo que vendes." class="input w-full p-3 rounded-lg text-sm resize-y min-h-[4rem]">Tu mejor opción para importaciones rápidas y seguras.</textarea>

            <label for="storeWhatsapp" class="block text-sm font-medium text-gray-500 mb-1">Número de WhatsApp (Contacto)</label>
            <input id="storeWhatsapp" type="tel" placeholder="Ej: +505 8888-8888" class="input w-full p-3 rounded-lg text-sm" value="8888-8888"/>
            
            <label for="storeYoutubeLink" class="block text-sm font-medium text-gray-500 mb-1">Video Publicitario de YouTube (Opcional)</label>
            <input id="storeYoutubeLink" type="url" placeholder="Ej: https://youtu.be/..." class="input w-full p-3 rounded-lg text-sm" value=""/>
            <p class="text-xs text-gray-500 mt-1">Recomendamos crear y subir un video publicitario para mejorar la conversión.</p>
          </div>

          <!-- LÓGICA DE NEGOCIO: STOCK vs. ENCARGO/DUAL -->
          <div class="flex items-center justify-between p-3 rounded-lg bg-gray-100 border border-gray-200">
            <label for="isLogisticsDualToggle" class="text-sm font-bold text-gray-700">
                <i class="fas fa-toggle-on text-indigo-500"></i> ¿Tienda de Encargo (Importación DUAL)?
                <p class="font-normal text-xs text-gray-500 mt-1">Activa si importas con envío Aéreo/Marítimo. Desactiva para tiendas con *Stock* local (ej. celulares).</p>
            </label>
            <label class="toggle-switch ml-4">
                <input type="checkbox" id="isLogisticsDualToggle" checked>
                <span class="slider"></span>
            </label>
          </div>

          <!-- Logistical Settings DUAL (CONDICIONAL) -->
          <div id="dualLogisticsContainer" class="mt-6 space-y-4">
              <h3 class="font-bold text-gray-700 mb-4 border-t pt-4">Ajustes DUALES de Logística y Tiempos</h3>
              <p class="text-sm text-indigo-600 mb-4 font-semibold">Define aquí las tarifas por libra y tiempos, necesarios para calcular el costo base de tus productos *Por Encargo*.</p>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <!-- Air Settings -->
                <div class="p-4 rounded-xl border border-blue-200 bg-blue-50">
                  <h4 class="font-bold text-blue-700 mb-3 flex items-center gap-2"><i class="fas fa-plane"></i> Envío Aéreo</h4>
                  <label for="airRate" class="block text-xs font-medium text-gray-500 mb-1">Costo por libra (Aéreo)</label>
                  <input id="airRate" type="number" placeholder="ej. 5.50" step="0.01" class="input w-full p-3 rounded-lg text-sm mb-3" value="5.50"/>

                  <label class="block text-xs font-medium text-gray-500 mb-1">Días de Entrega (Rango)</label>
                  <div class="flex gap-2">
                      <input id="airMinDays" type="number" placeholder="Min" class="input w-1/2 p-3 rounded-lg text-sm" value="7"/>
                      <input id="airMaxDays" type="number" placeholder="Max" class="input w-1/2 p-3 rounded-lg text-sm" value="15"/>
                  </div>
                </div>

                <!-- Sea Settings -->
                <div class="p-4 rounded-xl border border-green-200 bg-green-50">
                  <h4 class="font-bold text-green-700 mb-3 flex items-center gap-2"><i class="fas fa-ship"></i> Envío Marítimo</h4>
                  <label for="seaRate" class="block text-xs font-medium text-gray-500 mb-1">Costo por libra (Marítimo)</label>
                  <input id="seaRate" type="number" placeholder="ej. 3.00" step="0.01" class="input w-full p-3 rounded-lg text-sm mb-3" value="3.00"/>

                  <label class="block text-xs font-medium text-gray-500 mb-1">Días de Entrega (Rango)</label>
                  <div class="flex gap-2">
                      <input id="seaMinDays" type="number" placeholder="Min" class="input w-1/2 p-3 rounded-lg text-sm" value="30"/>
                      <input id="seaMaxDays" type="number" placeholder="Max" class="input w-1/2 p-3 rounded-lg text-sm" value="45"/>
                  </div>
                </div>
              </div>
          </div>
          
        </div>

        <!-- Products Card -->
        <div class="neumorphic-card p-6">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-box-open"></i> Productos y Márgenes</h3>
              <div class="text-sm text-gray-500 mt-1">Añade, edita y gestiona tus productos.</div>
            </div>
            <button id="addProductBtn" class="bg-blue-500 text-white p-2 rounded-full shadow-lg hover:bg-blue-600 transition-all duration-200 btn">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div id="productsList" class="space-y-4"></div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row justify-center items-center gap-4 py-4">
          <button id="saveStoreBtn" class="btn bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg hover:bg-blue-700 font-semibold"><i class="fas fa-save mr-2"></i> Guardar y Publicar Cambios</button>
          <a id="public-preview-btn" href="#" target="_blank" class="btn bg-gray-300 text-gray-600 px-6 py-3 rounded-full shadow-inner cursor-not-allowed opacity-50"><i class="fas fa-eye mr-2"></i> Ver Tienda en Vivo</a>
        </div>
      </div>
      
      <!-- Panel de Vista Previa -->
      <div class="flex flex-col space-y-8">
        <div id="previewCard" class="neumorphic-card p-6 min-h-[50vh]">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-eye"></i> Vista Previa (Simulada para Cliente)</h2>
          <div id="livePreview" class="neumorphic-card bg-gray-50 p-6 rounded-lg shadow-inner min-h-[40vh] text-center text-gray-500">
            <i class="fas fa-store-slash text-6xl mb-4 text-gray-300"></i>
            <p>Tu tienda aparecerá aquí. Actualiza la información para ver los cambios.</p>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Product Editor Modal (Lógica de Margen) -->
  <div id="productEditorModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay hidden">
    <div class="neumorphic-card p-6 rounded-2xl w-full max-w-xl relative animate-fade-in-up my-4 max-h-screen overflow-y-auto">
      <h3 class="text-2xl font-bold mb-4">Editar Producto</h3>
      <div class="space-y-6">
        
        <!-- Nombre, Imagen, Descripcion, Video -->
        <div>
          <label for="prodNameInput" class="block text-sm font-medium text-gray-500 mb-1">Nombre del Producto</label>
          <input id="prodNameInput" type="text" class="input w-full p-3 rounded-lg text-sm" />
        </div>
        <div>
          <label for="prodDescInput" class="block text-sm font-medium text-gray-500 mb-1">Descripción</label>
          <textarea id="prodDescInput" placeholder="Detalles, características o beneficios..." class="input w-full p-3 rounded-lg text-sm resize-y min-h-[4rem]"></textarea>
        </div>
        
        <div class="pt-2">
            <label for="prodYoutubeLink" class="block text-sm font-medium text-gray-500 mb-1">Video de YouTube del Producto (Opcional)</label>
            <input id="prodYoutubeLink" type="url" placeholder="Ej: https://youtu.be/..." class="input w-full p-3 rounded-lg text-sm" />
            <p class="text-xs text-gray-500 mt-1">Si está lleno, el cliente verá una opción para ver el video en la tarjeta.</p>
        </div>


        <!-- 3. CONFIGURACIÓN DE COSTOS (CRÍTICA y AHORA MÁS CLARA) -->
        <div class="space-y-4 p-4 border rounded-xl border-indigo-300 bg-indigo-50">
            <h4 class="font-semibold text-indigo-800 flex items-center gap-2 text-lg"><i class="fas fa-calculator"></i> Lógica Financiera</h4>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="prodInitialCost" class="block text-sm font-medium text-gray-700 mb-1">
                        1. Costo Inicial del Proveedor ($) <span class="text-xs text-gray-500">(Adquisición pura)</span>
                    </label>
                    <input id="prodInitialCost" type="number" step="0.01" value="0.00" class="input w-full p-3 rounded-lg text-sm font-mono" />
                </div>
                <!-- Peso (CONDICIONAL: SOLO PARA DUAL/ENCARGO) -->
                <div id="prodWeightContainer">
                    <label for="prodWeight" class="block text-sm font-medium text-gray-700 mb-1">
                        2. Peso Estimado (lb) <span class="text-xs text-gray-500">(Para cálculo de flete)</span>
                    </label>
                    <input id="prodWeight" type="number" step="0.01" value="0.00" class="input w-full p-3 rounded-lg text-sm font-mono" />
                </div>
            </div>

            <div class="border-t border-indigo-300 pt-4">
              <h4 class="text-sm font-bold text-indigo-800 mb-2">3. Define tu Margen de Ganancia</h4>
              <div class="flex gap-2 mb-4">
                  <select id="prodMarginType" class="input p-3 rounded-lg text-sm w-1/3">
                    <option value="fixed">Valor Fijo ($)</option>
                    <option value="percent">Porcentaje (%)</option>
                  </select>
                  <input id="prodMarginValue" type="number" step="0.01" value="5.00" class="input p-3 rounded-lg text-sm w-2/3 font-mono" />
              </div>
            </div>
            
            <!-- Display de Cálculo Automático DUAL (O ÚNICO para Stock) -->
            <div class="p-3 rounded-lg bg-indigo-200 text-indigo-800 font-mono text-sm">
                <p class="font-bold text-base mb-1">
                    Costo Base (Adquisición): <span id="baseCostAirDisplay" class="font-extrabold text-indigo-700">C$0.00</span> 
                    <span id="baseCostSeaDisplay" class="font-extrabold text-green-700 ml-4 hidden">C$0.00</span>
                </p>
                <p class="text-xs mt-2" id="formulaDisplay">
                    Fórmula (Dual): Proveedor + (Peso * Tarifa por lb). El **Costo Base (Adquisición)** es tu costo *real* antes de la ganancia.
                </p>
            </div>
        </div>

        <!-- 4. Disponibilidad y Método de Venta -->
        <div>
          <label for="prodStockMode" class="block text-sm font-medium text-gray-500 mb-1">Método de Venta</label>
          <select id="prodStockMode" class="input w-full p-3 rounded-lg text-sm">
            <option value="stock">Entrega Inmediata (Stock)</option>
            <option value="made">Por Encargo (Requiere Envío DUAL/Único)</option>
            <option value="both">Ambas (Stock limitado + Encargo)</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Si es Por Encargo, el cliente verá los precios de los métodos de envío disponibles.</p>
        </div>
        
        <!-- Contenedor Condicional: Por Encargo Opciones (SOLO VISIBLE SI LOGÍSTICA DUAL Y ES POR ENCARGO) -->
        <div id="madeToOrderContainer" class="space-y-4 p-4 border rounded-xl border-indigo-200 bg-indigo-50 hidden">
          <h4 class="font-semibold text-indigo-700">Opciones de Envío para Encargo</h4>
          <div>
            <label for="prodShipMethod" class="block text-sm font-medium text-gray-500 mb-1">Métodos de Envío Disponibles al Cliente</label>
            <select id="prodShipMethod" class="input w-full p-3 rounded-lg text-sm">
              <option value="both">Aéreo y Marítimo</option>
              <option value="air">Solo Aéreo</option>
              <option value="sea">Solo Marítimo</option>
              <option value="single">Único (Tiendas sin logística DUAL)</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Si la tienda no usa Logística DUAL, solo se aplicará el precio Único (Costo Base + Ganancia).</p>
          </div>
        </div>

        <!-- 5. Opciones de Delivery (Desde Tienda a Cliente) -->
        <div class="space-y-4 p-4 border rounded-xl border-gray-200 bg-gray-50">
          <h4 class="font-semibold text-gray-700">Costo de Delivery Local (Desde tu tienda al cliente)</h4>
          <div>
            <label for="prodDeliveryCostType" class="block text-sm font-medium text-gray-500 mb-1">Costo de Delivery</label>
            <select id="prodDeliveryCostType" class="input w-full p-3 rounded-lg text-sm">
              <option value="range">Costo por Rango (Extra)</option>
              <option value="fixed">Costo Fijo (Extra)</option>
              <option value="included">Incluído en el Precio Final</option>
              <option value="no">No disponible / Retiro en tienda</option>
            </select>
          </div>
          
          <div id="deliveryCostInputs" class="space-y-4 hidden">
            <div id="fixedCostInput" class="hidden">
              <label for="prodDeliveryFixed" class="block text-sm font-medium text-gray-500 mb-1">Valor Fijo de Envío</label>
              <input id="prodDeliveryFixed" type="number" step="0.01" placeholder="Ej: 5.00" class="input w-full p-3 rounded-lg text-sm" />
            </div>
            <div id="rangeCostInput" class="hidden grid grid-cols-2 gap-4">
              <div>
                <label for="prodDeliveryRangeStart" class="block text-sm font-medium text-gray-500 mb-1">Rango Mínimo</label>
                <input id="prodDeliveryRangeStart" type="number" step="0.01" placeholder="Ej: 2.00" class="input w-full p-3 rounded-lg text-sm" />
              </div>
              <div>
                <label for="prodDeliveryRangeEnd" class="block text-sm font-medium text-gray-500 mb-1">Rango Máximo</label>
                <input id="prodDeliveryRangeEnd" type="number" step="0.01" placeholder="Ej: 8.00" class="input w-full p-3 rounded-lg text-sm" />
              </div>
            </div>
            
            <div>
              <label for="prodDeliveryNote" class="block text-sm font-medium text-gray-500 mb-1">Nota Opcional (Máx 15 palabras)</label>
              <input id="prodDeliveryNote" type="text" placeholder="Ej: Costo varía por zona." class="input w-full p-3 rounded-lg text-sm" maxlength="80"/>
            </div>
          </div>
        </div>

        <!-- 6. Hashtags/Etiquetas -->
        <div>
          <label for="prodTags" class="block text-sm font-medium text-gray-500 mb-1">Etiquetas/Hashtags (Máx 5, separadas por coma)</label>
          <input id="prodTags" type="text" placeholder="Ej: #tendencia, #artesanal, #regalo" class="input w-full p-3 rounded-lg text-sm" />
          <div id="tagsPreview" class="mt-2 flex flex-wrap gap-2 text-xs"></div>
        </div>
        
        <!-- Image Input -->
        <div class="pt-4 border-t">
          <label class="block text-sm font-medium text-gray-500 mb-1">Imagen del Producto (Opcional)</label>
          <div id="prodImageDrop" class="w-full h-24 rounded-xl bg-gray-100 flex items-center justify-center border border-dashed border-gray-300 cursor-pointer overflow-hidden relative shadow-inner mb-2">
            <div id="prodImagePlaceholder" class="flex flex-col items-center text-gray-400">
              <i class="fas fa-camera text-xl mb-1"></i>
              <div class="text-xs">Seleccionar Imagen</div>
            </div>
            <img id="prodImagePreview" class="w-full h-full object-cover" style="display:none" alt="product image preview">
          </div>
          <input type="file" id="prodImageInput" accept="image/*" class="hidden" />
        </div>
        
      </div>
      
      <!-- Botones del Modal -->
      <div class="mt-6 flex justify-end gap-4">
        <button id="cancelProductBtn" class="btn bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-semibold hover:bg-gray-300">Cancelar</button>
        <button id="saveProductBtn" class="btn bg-blue-500 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-600">Guardar Producto</button>
      </div>
    </div>
  </div>

  <!-- Video Player Modal -->
  <div id="videoModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay hidden">
    <div class="neumorphic-card p-4 rounded-2xl w-full max-w-4xl relative animate-fade-in-up">
      <button id="closeVideoModal" class="absolute top-4 right-4 z-10 btn bg-white text-gray-700 w-8 h-8 rounded-full shadow-lg hover:bg-gray-200"><i class="fas fa-times"></i></button>
      <div id="videoContent" class="w-full aspect-video rounded-xl overflow-hidden">
        <!-- YouTube iframe will be loaded here -->
      </div>
      <div id="videoTitle" class="text-lg font-bold mt-3 text-center"></div>
    </div>
  </div>


  <!-- Message Modal -->
  <div id="messageModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay hidden">
    <div class="neumorphic-card p-6 rounded-2xl w-full max-w-sm relative text-center">
      <div id="messageText" class="text-lg font-semibold mb-4"></div>
      <button id="messageOkBtn" class="btn bg-blue-500 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-600">OK</button>
    </div>
  </div>

  <script src="../js/editor.js?v=2" defer></script>
</body>
</html>
