<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Tienda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e0e5ec; }
        .neomorphic-card { background-color: #e0e5ec; border-radius: 1rem; box-shadow: 8px 8px 16px #c8cdd4, -8px -8px 16px #f8fdff; }
        .neomorphic-btn { background-color: #e0e5ec; border-radius: 0.5rem; font-weight: 600; box-shadow: 5px 5px 10px #c8cdd4, -5px -5px 10px #f8fdff; transition: all 0.3s ease-in-out; padding: 10px 20px; }
        .neomorphic-btn:hover { box-shadow: inset 2px 2px 5px #c8cdd4, inset -2px -2px 5px #f8fdff; color: #3b82f6; }
        .neomorphic-input { background-color: #e0e5ec; border-radius: 0.5rem; padding: 0.5rem; box-shadow: inset 2px 2px 5px #c8cdd4, inset -2px -2px 5px #f8fdff; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-[#e0e5ec] text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden"><div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-white"></div></div>
    <div id="toast-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden"></div>

    <main class="container mx-auto p-4 md:p-8">
        <div class="neomorphic-card p-6 md:p-10 mb-8 flex flex-col items-center text-center">
            <div class="relative mb-4">
                <img id="logo-img" src="https://placehold.co/100x100/e0e5ec/6366f1?text=Logo" alt="Logo de la tienda" class="neomorphic-card p-1 rounded-full w-24 h-24 object-cover">
                <label for="logo-upload-input" id="logo-upload-btn" class="absolute bottom-0 right-0 p-2 rounded-full neomorphic-btn cursor-pointer hidden"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3.5L14.5 4z"/><circle cx="12" cy="13" r="3"/></svg></label>
                <input type="file" id="logo-upload-input" class="hidden" accept="image/*">
            </div>
            <h1 id="store-name" class="text-4xl font-bold mb-2 editable" contenteditable="false"></h1>
            <p id="store-description" class="text-gray-600 mb-6 editable" contenteditable="false"></p>
            <div id="editor-controls" class="flex flex-wrap justify-center gap-4">
                <button id="edit-mode-btn" class="neomorphic-btn">Activar Edición</button>
                <button id="launch-btn" class="neomorphic-btn bg-indigo-600 text-white hidden">Guardar y Salir</button>
            </div>
        </div>
        <section id="products" class="mb-8">
            <h2 class="text-2xl font-bold mb-6 text-center">Nuestros Productos</h2>
            <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>
    </main>

    <script>
        // --- CONFIG & GLOBAL STATE ---
        const SUPABASE_URL = "https://vuoospopyjojarfzjjiu.supabase.co";
        const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1b29zcG9weWpvamFyZnpqaml1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNTg5MjAsImV4cCI6MjA3MzYzNDkyMH0.IH-h0HlvxeK73Y9wXtvJUwmVRgsFi5RwaiQSmlqv7gM";
        const SERVICE_ROLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1b29zcG9weWpvamFyZnpqaml1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODA1ODkyMCwiZXhwIjoyMDczNjM0OTIwfQ.xV-cQuZrrDJtGvVq0jq6lpDvt30jZWYVI-95dsI4pAo";
        const BUCKET_NAME = 'Imagenes_tiendas';

        const storeId = new URLSearchParams(window.location.search).get('storeId');
        let isEditing = false;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (!storeId) {
                return showError('Falta el ID de la tienda en la URL.');
            }
            const jwt = localStorage.getItem('jwt_token');
            if (!jwt) {
                alert('Sesión no válida. Serás redirigido al login.');
                window.location.href = '/login.html';
                return;
            }
            try {
                await loadStoreData();
            } catch (error) {
                showError(error.message);
            }
            setupEventListeners();
        });

        // --- DATA FUNCTIONS ---
        async function loadStoreData() {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/stores?id=eq.${storeId}&select=data`, {
                headers: { "apikey": ANON_KEY, "Authorization": `Bearer ${SERVICE_ROLE_KEY}` }
            });
            if (!response.ok) throw new Error('Error al cargar la tienda.');
            const result = await response.json();
            if (result.length === 0 || !result[0].data) throw new Error('No se encontró la tienda.');
            localStorage.setItem('storeData', JSON.stringify(result[0].data));
            renderStore(result[0].data);
        }

        async function saveStoreData() {
            const storeData = JSON.parse(localStorage.getItem('storeData'));
            const response = await fetch(`${SUPABASE_URL}/rest/v1/stores?id=eq.${storeId}`, {
                method: "PATCH",
                headers: { "apikey": ANON_KEY, "Authorization": `Bearer ${SERVICE_ROLE_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({ data: storeData })
            });
            if (!response.ok) throw new Error('Error al guardar en Supabase.');
        }

        async function uploadFile(file, path) {
            const response = await fetch(`${SUPABASE_URL}/storage/v1/object/${path}`, {
                method: 'POST',
                headers: {
                    "apikey": ANON_KEY,
                    "Authorization": `Bearer ${SERVICE_ROLE_KEY}`,
                    "Content-Type": file.type,
                },
                body: file,
            });
            if (!response.ok) throw new Error('Error al subir el archivo.');
            return `${SUPABASE_URL}/storage/v1/object/public/${path}`;
        }

        // --- UI RENDERING ---
        function renderStore(data) {
            document.getElementById('logo-img').src = data.logo || 'https://placehold.co/100x100/e0e5ec/6366f1?text=Logo';
            document.getElementById('store-name').textContent = data.storeName || 'Nombre de la Tienda';
            document.getElementById('store-description').textContent = data.description || 'Descripción de tu negocio.';
            renderProducts(data.products || []);
        }

        function renderProducts(products) {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            products.forEach(product => {
                container.innerHTML += `
                    <div class="p-6 neomorphic-card flex flex-col relative" data-id="${product.id}">
                        ${isEditing ? `<button onclick="removeProduct('${product.id}')" class="absolute top-2 right-2 text-red-500">&times;</button>` : ''}
                        <div class="relative w-full h-48 mb-4">
                            <img src="${product.image || 'https://placehold.co/400x300/e0e5ec/6366f1?text=Producto'}" alt="${product.name}" class="rounded-lg object-cover h-full w-full neomorphic-card p-2">
                            ${isEditing ? `<label for="product-img-upload-${product.id}" class="absolute bottom-2 right-2 p-2 rounded-full neomorphic-btn cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3.5L14.5 4z"/><circle cx="12" cy="13" r="3"/></svg></label><input type="file" id="product-img-upload-${product.id}" class="hidden" accept="image/*" onchange="handleProductImageUpload(event, '${product.id}')">` : ''}
                        </div>
                        <div class="font-semibold text-lg mb-2">${isEditing ? `<input type="text" value="${product.name}" oninput="updateProduct('${product.id}', 'name', this.value)" class="neomorphic-input w-full">` : product.name}</div>
                        <div class="font-bold text-xl text-indigo-600 mb-4">${isEditing ? `<input type="number" value="${product.price}" oninput="updateProduct('${product.id}', 'price', this.value)" class="neomorphic-input w-24">` : `${product.currency} ${product.price}`}</div>
                        <div class="text-sm text-gray-500 mb-2">${isEditing ? `<label>Peso (kg): <input type="number" value="${product.weight || ''}" oninput="updateProduct('${product.id}', 'weight', this.value)" class="neomorphic-input w-20"></label>` : `Peso: ${product.weight || 0}kg`}</div>
                    </div>`;
            });
            if (isEditing) container.innerHTML += `<div class="p-6 flex items-center justify-center neomorphic-card border-dashed border-2"><button onclick="addProduct()" class="neomorphic-btn">+ Agregar Producto</button></div>`;
        }

        // --- UI & LOGIC FUNCTIONS ---
        function getUserIdFromToken() {
            const token = localStorage.getItem('jwt_token');
            if (!token) return null;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.sub;
            } catch (e) { return null; }
        }

                async function handleImageUpload(event, type, id) {
            const file = event.target.files[0];
            if (!file) return;

            // --- COMPRESSION LOGIC ---
            if (!window.imageCompression) {
                return showError('Error: La librería de compresión de imágenes no se ha cargado.');
            }
            const options = {
                maxSizeMB: 0.5,       // Apuntar a un máximo de 0.5MB
                maxWidthOrHeight: 1280, // Redimensionar si es más grande de 1280px
                useWebWorker: true,
                fileType: 'image/jpeg',
            };
            let compressedFile;
            try {
                showToast('Optimizando imagen...');
                compressedFile = await imageCompression(file, options);
            } catch (error) {
                console.error(error);
                return showError('No se pudo optimizar la imagen.');
            }
            // --- END COMPRESSION ---

            const userId = getUserIdFromToken();
            if (!userId) return showToast('Error de autenticación.', true);

            showToast('Subiendo imagen optimizada...');
            const fileExt = compressedFile.name.split('.').pop() || 'jpg';
            const filePath = `${BUCKET_NAME}/${userId}/${id}-${Date.now()}.${fileExt}`;

            try {
                const publicUrl = await uploadFile(compressedFile, filePath);
                const storeData = JSON.parse(localStorage.getItem('storeData'));
                if (type === 'logo') {
                    storeData.logo = publicUrl;
                } else if (type === 'product') {
                    const product = storeData.products.find(p => p.id === id);
                    if (product) product.image = publicUrl;
                }
                localStorage.setItem('storeData', JSON.stringify(storeData));
                renderStore(storeData);
                showToast('Imagen actualizada.');
            } catch (error) {
                showError(error.message);
            }
        }

        const handleLogoUpload = (e) => handleImageUpload(e, 'logo', 'logo');
        const handleProductImageUpload = (e, id) => handleImageUpload(e, 'product', id);

        function updateProduct(id, key, value) {
            const storeData = JSON.parse(localStorage.getItem('storeData'));
            const product = storeData.products.find(p => p.id === id);
            if (product) product[key] = value;
            localStorage.setItem('storeData', JSON.stringify(storeData));
        }

        function addProduct() {
            const storeData = JSON.parse(localStorage.getItem('storeData'));
            const newProduct = { id: `prod_${Date.now()}`, name: 'Nuevo Producto', price: 10, currency: 'C$', products: [] };
            storeData.products.push(newProduct);
            localStorage.setItem('storeData', JSON.stringify(storeData));
            renderProducts(storeData.products);
        }

        function removeProduct(id) {
            let storeData = JSON.parse(localStorage.getItem('storeData'));
            storeData.products = storeData.products.filter(p => p.id !== id);
            localStorage.setItem('storeData', JSON.stringify(storeData));
            renderProducts(storeData.products);
        }

        function toggleEditMode() {
            isEditing = !isEditing;
            document.getElementById('launch-btn').classList.toggle('hidden');
            document.getElementById('logo-upload-btn').classList.toggle('hidden');
            const editBtn = document.getElementById('edit-mode-btn');
            editBtn.textContent = isEditing ? 'Guardar Cambios' : 'Activar Edición';
            if (!isEditing) saveChanges();
            renderStore(JSON.parse(localStorage.getItem('storeData')));
        }

        async function saveChanges() {
            showToast('Guardando cambios...');
            try {
                await saveStoreData();
                showToast('¡Guardado con éxito!');
            } catch (error) {
                showError(error.message);
            }
        }

        async function launchAndExit() {
            await saveChanges();
            window.location.href = '/dashboard.html';
        }

        function setupEventListeners() {
            document.getElementById('edit-mode-btn').addEventListener('click', toggleEditMode);
            document.getElementById('launch-btn').addEventListener('click', launchAndExit);
            document.getElementById('logo-upload-input').addEventListener('change', handleLogoUpload);
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function showError(message) {
            document.body.innerHTML = `<div class="w-full h-screen flex items-center justify-center"><h1 class="text-center text-2xl font-bold text-red-600 p-8 neomorphic-card">${message}</h1></div>`;
        }

    </script>
</body>
</html>